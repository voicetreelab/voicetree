name: Update Installers

on:
  workflow_dispatch:
    inputs:
      update_homebrew:
        description: 'Update Homebrew tap with latest release'
        type: boolean
        default: true
      test_install_script:
        description: 'Test install.sh against latest release'
        type: boolean
        default: false

jobs:
  update-homebrew:
    if: ${{ inputs.update_homebrew }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get latest release info
        id: release
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          VERSION=$(gh release view --json tagName -q '.tagName' | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest release: $VERSION"

      - name: Download release DMGs
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          VERSION=${{ steps.release.outputs.version }}
          mkdir -p artifacts
          gh release download "v$VERSION" -p "voicetree-arm64.dmg" -D artifacts/
          gh release download "v$VERSION" -p "voicetree-x64.dmg" -D artifacts/
          ls -la artifacts/

      - name: Calculate SHA256
        id: sha
        run: |
          ARM_SHA256=$(shasum -a 256 artifacts/voicetree-arm64.dmg | awk '{print $1}')
          INTEL_SHA256=$(shasum -a 256 artifacts/voicetree-x64.dmg | awk '{print $1}')
          echo "arm=$ARM_SHA256" >> $GITHUB_OUTPUT
          echo "intel=$INTEL_SHA256" >> $GITHUB_OUTPUT
          echo "ARM64 SHA256: $ARM_SHA256"
          echo "Intel SHA256: $INTEL_SHA256"

      - name: Update Homebrew tap
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          VERSION=${{ steps.release.outputs.version }}
          ARM_SHA256=${{ steps.sha.outputs.arm }}
          INTEL_SHA256=${{ steps.sha.outputs.intel }}

          git clone https://x-access-token:${GH_TOKEN}@github.com/voicetreelab/homebrew-voicetree.git tap

          cat > tap/Casks/voicetree.rb << EOF
          cask "voicetree" do
            version "$VERSION"

            on_arm do
              sha256 "$ARM_SHA256"
              url "https://github.com/voicetreelab/voicetree/releases/download/v#{version}/voicetree-arm64.dmg"
            end

            on_intel do
              sha256 "$INTEL_SHA256"
              url "https://github.com/voicetreelab/voicetree/releases/download/v#{version}/voicetree-x64.dmg"
            end

            name "Voicetree"
            desc "Transform voice into navigable concept graphs"
            homepage "https://github.com/voicetreelab/voicetree"
            depends_on macos: ">= :monterey"
            app "Voicetree.app"

            postflight do
              system_command "/usr/bin/open", args: ["#{appdir}/Voicetree.app"]
            end

            zap trash: [
              "~/Library/Application Support/VoiceTree",
              "~/Library/Preferences/com.voicetree.webapp.plist",
            ]
          end
          EOF

          echo "=== Generated cask ==="
          cat tap/Casks/voicetree.rb

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged
          git commit -m "Update Voicetree to v$VERSION" || echo "No changes to commit"
          git push

  test-install-script:
    if: ${{ inputs.test_install_script }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Shellcheck
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          shellcheck install.sh

      - name: Run install script
        run: |
          chmod +x install.sh
          ./install.sh

      - name: Verify installation
        run: |
          ls -la ~/.local/bin/
          ~/.local/bin/voicetree --version || echo "Note: --version may not be supported"

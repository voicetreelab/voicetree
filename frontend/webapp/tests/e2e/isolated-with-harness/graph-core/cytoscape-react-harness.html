<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cytoscape React Test Harness</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #cy {
      width: 100%;
      height: 100%;
      background: #f5f5f5;
      position: relative;
    }
  </style>
</head>
<body>
  <div id="cy"></div>
  <script type="module">
    // This harness provides a clean environment for Cytoscape tests.
    // Test files can use page.evaluate() to interact with the 'cy' instance.
    import cytoscape from 'cytoscape';
    import React from 'react';
    import ReactDOM from 'react-dom/client';
    // Import graph-core which auto-registers the floating windows extension
    import '../../../../src/graph-core/index.ts';
    // Import layout system
    import { LayoutManager } from '../../../../src/graph-core/graphviz/layout/LayoutManager.ts';
    import { TidyLayoutStrategy } from '../../../../src/graph-core/graphviz/layout/TidyLayoutStrategy.ts';

    const cy = cytoscape({
      container: document.getElementById('cy'),
      // Tests can override these elements and styles as needed.
      elements: [],
      style: [
        {
          selector: 'node',
          style: { 'background-color': '#0074D9', 'width': 30, 'height': 30 }
        },
        {
          selector: 'edge',
          style: { 'line-color': '#cccccc', 'width': 2 }
        }
      ]
    });

    // Set up layout manager with TidyLayoutStrategy (partial relayout support)
    const layoutManager = new LayoutManager(new TidyLayoutStrategy());
    window.layoutManager = layoutManager;

    // Track dimension changes and trigger partial relayout
    const dimensionChangeMap = new Map();
    cy.on('floatingwindow:resize', async (event, data) => {
      const nodeId = data.nodeId;
      console.log(`[Harness] Floating window resized: ${nodeId}`);

      // Debounce dimension changes per node
      if (dimensionChangeMap.has(nodeId)) {
        clearTimeout(dimensionChangeMap.get(nodeId));
      }

      dimensionChangeMap.set(nodeId, setTimeout(async () => {
        // Trigger partial layout for this node
        console.log(`[Harness] Triggering partial layout for ${nodeId}`);
        await layoutManager.applyLayout(cy, [nodeId]);
        dimensionChangeMap.delete(nodeId);
      }, 100));
    });

    window.cy = cy;
    window.cytoscape = cytoscape;
    window.React = React;
    window.ReactDOM = ReactDOM;
    window.extensionLoaded = true;

    // Signal that the harness is ready
    document.body.setAttribute('data-harness-ready', 'true');
  </script>
</body>
</html>

/**
 * Floating Windows CSS - Core
 *
 * Styles for the floating window overlay, individual windows, and horizontal menus
 */

/* Overlay container - sibling to cytoscape container */
.cy-floating-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1000;
  transform-origin: top left;
}

/* Individual floating windows */
.cy-floating-window {
  position: absolute;
  pointer-events: auto;
  box-sizing: border-box;
  min-width: 100px;
  min-height: 100px;
  /* max-height: 600px; */ /* Disabled to allow terminal windows to expand freely */
  background: var(--card);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
  display: flex;
  flex-direction: column;
  color: var(--foreground);
}

/* =============================================================================
 * Editor Accent Bar (card-style left colored bar)
 * Matches the node-presentation accent bar for visual cohesion
 * ============================================================================= */

.cy-floating-window-accent {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 3px;
  border-top-left-radius: 6px;
  border-bottom-left-radius: 6px;
  opacity: 0.7;
  background: var(--editor-accent-color, #4a9eff);
  z-index: 3;
}

/* Editor-specific window styling — match card visual language */
.cy-floating-window-editor {
  border: 1px solid rgba(255, 255, 255, 0.08);
  transition: box-shadow 0.15s ease, border-color 0.15s ease;
}

.cy-floating-window-editor:hover {
  border-color: rgba(255, 255, 255, 0.15);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.35);
}

/* Window wrapper container */
.cy-floating-window-wrapper {
  display: flex;
  flex-direction: column;
  height: 100%;
  width: 100%;
}


/* Content area */
.cy-floating-window-content {
  flex: 1;
  overflow: auto;
}

/* Fullscreen mode - ensure proper background in light mode */
.cy-floating-window-content:fullscreen {
  background-color: var(--background, white);
}

/* Resizable windows - Phase 2C: macOS-style edge resizing replaces CSS resize: both */
/* overflow: visible allows resize zones to extend outside window bounds (avoiding scrollbar overlap) */
.cy-floating-window.resizable {
  overflow: visible;
}

/* Shadow nodes (invisible) */
.floating-window-node {
  opacity: 0;
}

/* Hide expand button at very low zoom — too small to be useful */
.zoom-below-toolbar-threshold .cy-floating-window-expand-corner {
  display: none !important;
}

/* =============================================================================
 * Card Mode (unified editor — CSS-controlled chrome visibility)
 * .mode-card: compact read-only card (chrome hidden, no interaction)
 * .mode-edit: full editor (chrome visible, editable)
 * ============================================================================= */

/* Card header — title + preview, visible only in card mode */
.cy-floating-window-card-header {
  display: none;
  padding: 8px 12px 8px 16px;
}

.cy-floating-window-card-preview {
  font-size: 11px;
  color: var(--muted-foreground);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 5;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Shared transition for card mode switches (card ↔ edit ↔ pinned) */
.mode-card,
.mode-edit,
.mode-pinned {
  transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
              width 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Card mode — compact card (chrome hidden, interaction disabled, faded bottom) */
.mode-card {
  max-height: 115px;
  overflow: hidden;
  -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
  mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
}

.mode-card .cy-floating-window-horizontal-menu {
  display: none;
}

.mode-card .cy-floating-window-expand-corner {
  display: none;
}

.mode-card .cy-floating-window-card-header {
  display: block;
}

.mode-card .cm-gutters {
  display: none;
}

.mode-card .cm-content {
  pointer-events: none;
  caret-color: transparent;
}

/* Edit mode — spacious hover preview (chrome visible, scrollable) */
.mode-edit {
  max-height: 280px;
  overflow: auto;
  -webkit-mask-image: none;
  mask-image: none;
}

.mode-edit .cy-floating-window-card-header {
  display: none;
}

.mode-edit .cy-floating-window-horizontal-menu {
  display: flex;
}

/* Pinned mode — full editor (card header hidden) */
.mode-pinned {
  max-height: 400px;
  -webkit-mask-image: none;
  mask-image: none;
}

/* Hide resize zones in card and edit modes — only interactive when pinned */
.mode-card [class*="resize-zone"],
.mode-edit [class*="resize-zone"] {
  display: none;
}

/* Card mode overflow must remain hidden (for gradient mask) even when resizable */
.mode-card.resizable {
  overflow: hidden;
}

/* Edit mode overflow must remain auto (for scrolling) even when resizable */
.mode-edit.resizable {
  overflow: auto;
}

/* Pinned resizable editors: remove max-height cap so user can resize freely */
.mode-pinned.resizable {
  max-height: 9999px;
}

.mode-pinned .cy-floating-window-card-header {
  display: none;
}

.mode-pinned .cy-floating-window-horizontal-menu {
  display: flex;
}

/* =============================================================================
 * Horizontal Menu System
 * Pill-shaped menu buttons with left/right groups and submenus
 * ============================================================================= */

/* Horizontal context menu pill backgrounds
 * Matches the floating window title bar color (--muted)
 * Supports light/dark mode via CSS variables
 * pointer-events: auto to re-enable clicks (parent container has pointer-events: none) */
.horizontal-menu-pill {
  display: flex;
  flex-direction: row;
  align-items: center;
  background: var(--muted);
  border-radius: 16px;
  padding: 4px 8px;
  pointer-events: auto;
}

/* Ensure left and right pill groups have equal width for balanced centering
 * This keeps the spacer (and node circle) centered in the menu */
.horizontal-menu-left-group,
.horizontal-menu-right-group {
  flex: 1 1 0;
  min-width: 0;
}

.horizontal-menu-left-group {
  justify-content: flex-end;
}

.horizontal-menu-right-group {
  justify-content: flex-start;
}

/* Floating window chrome horizontal menu wrapper
 * Displays left and right pill groups with centered spacer for node circle gap
 * Draggable area for moving the floating window */
.cy-floating-window-horizontal-menu {
  position: relative; /* Required for slider's position: absolute; bottom: 100% */
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 0;
  padding: 8px;
  cursor: grab;
  z-index: 2; /* Above resize zones (z-index: 1) so traffic light buttons are clickable */
}

.cy-floating-window-horizontal-menu:active {
  cursor: grabbing;
}

/* Vertical submenu dropdown from horizontal menu
 * Uses CSS variables for dark mode support */
.horizontal-menu-submenu {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  display: none;
  flex-direction: column;
  background: var(--card);
  border: 1px solid var(--border);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border-radius: 8px;
  padding: 2px 0;
  z-index: 10001;
  pointer-events: auto;
  color: var(--foreground);
}

/* =============================================================================
 * Transcription Preview Chip
 * Floating confirmation UI for speech-to-text
 * ============================================================================= */

.transcription-preview-chip {
  position: fixed;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  backdrop-filter: blur(8px);
  z-index: 10000;
  max-width: 400px;
  font-size: 14px;
  pointer-events: auto;
}

.transcription-preview-chip .preview-text {
  flex: 1;
  overflow-wrap: break-word;
  word-wrap: break-word;
  color: var(--foreground);
}

.transcription-preview-chip .preview-hints {
  color: var(--muted-foreground);
  font-size: 12px;
  white-space: nowrap;
}

/* =============================================================================
 * Bottom-Left Expand Button (Phase 2B)
 * Small icon button in bottom-left corner for expanding/minimizing window
 * Visually distinct from CSS resize handles
 * ============================================================================= */

.cy-floating-window-expand-corner {
  all: unset;
  cursor: pointer;
  position: absolute;
  bottom: 0;
  left: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 2px;
  background-color: var(--muted);
  border: 1px solid var(--border);
  color: var(--muted-foreground);
  opacity: 1;
  transition: background-color 0.15s ease;
  z-index: 10; /* Above content but below menus */
}

.cy-floating-window-expand-corner:hover {
  opacity: 1;
  background-color: var(--accent);
  color: var(--foreground);
}

.cy-floating-window-expand-corner svg {
  width: 16px;
  height: 16px;
  stroke: currentColor;
  stroke-width: 2;
}

/* =============================================================================
 * Headless Agent Badge
 * Status badge overlay on task nodes for headless (background) agents.
 * Positioned in the overlay at task node coordinates, no shadow nodes.
 * ============================================================================= */

.headless-agent-badge {
  position: absolute;
  /* transform + transform-origin set by JS (repositionBadges) for CSS-transform zoom scaling */
  pointer-events: auto;
  cursor: default;
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-family: var(--font-mono, monospace);
  white-space: nowrap;
  background: rgba(0, 0, 0, 0.75);
  color: #e0e0e0;
  backdrop-filter: blur(4px);
  transition: background 0.15s ease;
}

.headless-agent-badge:hover {
  background: rgba(0, 0, 0, 0.9);
}

.headless-badge-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}

.headless-agent-badge.running .headless-badge-dot {
  background: #22c55e;
  animation: headless-badge-pulse 2s ease-in-out infinite;
}

.headless-agent-badge.exited .headless-badge-dot {
  background: #22c55e;
}

@keyframes headless-badge-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.headless-badge-name {
  font-weight: 600;
}

.headless-badge-status {
  opacity: 0.7;
}

/* Minimized agent badge variant — purple accent, clickable to restore */
.headless-agent-badge.minimized {
  cursor: pointer;
  border: 1px solid rgba(167, 139, 250, 0.3);
}

.headless-agent-badge.minimized:hover {
  background: rgba(167, 139, 250, 0.2);
  border-color: rgba(167, 139, 250, 0.6);
}

.headless-agent-badge.minimized .headless-badge-dot {
  background: #a78bfa;
}

.headless-agent-badge.minimized.running .headless-badge-dot {
  background: #a78bfa;
  animation: headless-badge-pulse 2s ease-in-out infinite;
}

.headless-agent-badge.minimized.idle .headless-badge-dot {
  background: #a78bfa;
  animation: none;
  opacity: 0.6;
}

/* =============================================================================
 * Headless Agent Output Popover
 * Floating popover showing captured stdout+stderr on badge hover.
 * ============================================================================= */

.headless-output-popover {
  position: fixed;
  z-index: 10002;
  pointer-events: auto;
  max-width: 480px;
  max-height: 300px;
  min-width: 200px;
  overflow-y: auto;
  padding: 8px 10px;
  border-radius: 6px;
  background: rgba(15, 15, 15, 0.95);
  color: #d4d4d4;
  font-family: var(--font-mono, monospace);
  font-size: 11px;
  line-height: 1.4;
  white-space: pre-wrap;
  word-break: break-all;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(8px);
}

.headless-output-popover::-webkit-scrollbar {
  width: 6px;
}

.headless-output-popover::-webkit-scrollbar-track {
  background: transparent;
}

.headless-output-popover::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.15);
  border-radius: 3px;
}

.headless-output-popover::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.25);
}

/* =============================================================================
 * Node Flash Animations (migrated from node-presentation.css)
 * Applied via JS to card shell windows for new-node and content-changed events
 * ============================================================================= */

/* New node flash — green pulse (one-shot, NO breathing) */
@keyframes node-presentation-new-pulse {
  0%   { box-shadow: 0 0 0 0 rgba(48, 209, 88, 0.6); }
  50%  { box-shadow: 0 0 0 8px rgba(48, 209, 88, 0); }
  100% { box-shadow: 0 0 0 0 rgba(48, 209, 88, 0); }
}
.node-presentation-new {
  animation: node-presentation-new-pulse 1.5s ease-out;
}

/* Content changed flash — cyan pulse (one-shot, NO breathing) */
@keyframes node-presentation-content-pulse {
  0%   { box-shadow: 0 0 0 0 rgba(0, 200, 255, 0.5); }
  50%  { box-shadow: 0 0 0 6px rgba(0, 200, 255, 0); }
  100% { box-shadow: 0 0 0 0 rgba(0, 200, 255, 0); }
}
.node-presentation-content-changed {
  animation: node-presentation-content-pulse 1.5s ease-out;
}

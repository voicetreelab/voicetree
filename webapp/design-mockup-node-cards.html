<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoiceTree — Node Card Redesign v2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Geist:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:           #1a1a1a;
    --card-bg:      #222222;
    --border:       rgba(255,255,255,0.06);
    --border-hover: rgba(255,255,255,0.14);
    --border-focus: rgba(255,255,255,0.26);
    --border-active: #4a9eff;
    --text:         rgba(255,255,255,0.82);
    --text-muted:   rgba(255,255,255,0.38);
    --text-dim:     rgba(255,255,255,0.55);
    --edge:         rgba(255,255,255,0.12);
    --edge-hi:      rgba(255,255,255,0.35);
    --tl-close: #ff5f57;
    --tl-min:   #febc2e;
    --tl-full:  #28c840;
    --font: 'Geist', system-ui, sans-serif;
    --mono: 'Fira Code', monospace;
    --r: 11px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    font-family: var(--font);
    color: var(--text);
    overflow: hidden;
    height: 100vh;
    user-select: none;
  }

  /* ── Canvas ── */
  #wrap {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    cursor: grab;
  }
  #wrap.panning { cursor: grabbing; }

  #canvas {
    position: absolute;
    width: 3200px;
    height: 2400px;
    transform-origin: 0 0;
  }

  /* dot grid */
  #canvas::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image: radial-gradient(circle, rgba(255,255,255,0.045) 1px, transparent 1px);
    background-size: 32px 32px;
    pointer-events: none;
  }

  /* ── SVG edges ── */
  #svg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: visible;
  }
  .edge {
    stroke: var(--edge);
    stroke-width: 1.5;
    fill: none;
    transition: stroke 0.15s, stroke-width 0.15s;
    marker-end: url(#arr);
  }
  .edge.lit {
    stroke: var(--edge-hi);
    stroke-width: 2;
    marker-end: url(#arr-lit);
  }

  /* ── Cards ── */
  .card {
    position: absolute;
    width: 240px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--r);
    padding: 12px 14px 13px;
    cursor: pointer;
    transition:
      border-color 0.12s,
      box-shadow 0.12s,
      width 0.18s ease,
      height 0.18s ease;
  }

  /* hover */
  .card:hover {
    border-color: var(--border-hover);
    box-shadow: 0 3px 14px rgba(0,0,0,0.3);
  }
  .card:hover .tls { opacity: 1; pointer-events: auto; }

  /* selected / focus */
  .card.focused {
    border-color: var(--border-focus);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }

  /* active (editing) */
  .card.active {
    width: 380px;
    border-color: var(--border-active);
    box-shadow: 0 0 0 1px rgba(74,158,255,0.15), 0 8px 32px rgba(0,0,0,0.5);
    cursor: default;
    padding: 0;
  }

  /* ── Minimal content ── */
  .c-min { padding: 12px 14px 13px; }
  .card.active .c-min { display: none; }

  .c-title {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    letter-spacing: -0.01em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 5px;
  }

  .c-body {
    font-size: 12px;
    font-weight: 300;
    color: var(--text-muted);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* traffic lights: hidden until hover */
  .tls {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.12s;
    pointer-events: none;
  }
  .tl {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    cursor: pointer;
    transition: filter 0.1s, transform 0.1s;
  }
  .tl:hover { filter: brightness(1.25); transform: scale(1.15); }
  .tl.x { background: var(--tl-close); }
  .tl.m { background: var(--tl-min); }
  .tl.f { background: var(--tl-full); }

  /* ── Full / active editor ── */
  .c-full {
    display: none;
    flex-direction: column;
  }
  .card.active .c-full {
    display: flex;
    min-height: 260px;
  }

  .c-bar {
    display: flex;
    align-items: center;
    gap: 7px;
    padding: 8px 12px 7px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    cursor: grab;
    flex-shrink: 0;
  }
  .c-bar:active { cursor: grabbing; }

  .c-bar-title {
    font-size: 11.5px;
    font-weight: 500;
    color: var(--text-dim);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    letter-spacing: -0.01em;
  }

  .tls-bar { display: flex; gap: 5px; }

  .c-editor {
    flex: 1;
    padding: 11px 14px 13px;
    overflow-y: auto;
    font-family: var(--mono);
    font-size: 11.5px;
    line-height: 1.75;
    color: var(--text-dim);
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.08) transparent;
  }

  .ln {
    display: flex;
    gap: 14px;
  }
  .lnum {
    color: rgba(255,255,255,0.2);
    min-width: 18px;
    text-align: right;
    font-size: 10px;
    padding-top: 1.5px;
    flex-shrink: 0;
    font-variant-numeric: tabular-nums;
  }
  .lc { flex: 1; word-break: break-word; }
  .lc.h1 { color: rgba(255,255,255,0.82); font-weight: 500; font-size: 12px; font-family: var(--font); }
  .lc.h2 { color: rgba(255,255,255,0.65); font-family: var(--font); }
  .lc.kw { color: #a78bfa; }
  .lc.str { color: #86efac; }
  .lc.num { color: #fdba74; }
  .lc.cm  { color: rgba(255,255,255,0.28); font-style: italic; }

  /* resize */
  .rsz {
    position: absolute;
    bottom: 0; right: 0;
    width: 16px; height: 16px;
    cursor: se-resize;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding: 3px;
    opacity: 0;
    transition: opacity 0.12s;
  }
  .card.active .rsz { opacity: 0.35; }
  .card.active .rsz:hover { opacity: 0.8; }

  /* ── Header bar ── */
  #hdr {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 18px;
    background: rgba(26,26,26,0.88);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    backdrop-filter: blur(10px);
    z-index: 999;
  }
  #hdr-label {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 0.04em;
  }
  #hdr-label b { color: rgba(255,255,255,0.55); font-weight: 400; }

  #hdr-btns { display: flex; gap: 7px; align-items: center; }
  .hbtn {
    font-family: var(--font);
    font-size: 11px;
    padding: 3px 10px;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 5px;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.1s;
  }
  .hbtn:hover { background: rgba(255,255,255,0.05); color: var(--text-dim); }
  .hbtn.on { border-color: rgba(74,158,255,0.5); color: #4a9eff; background: rgba(74,158,255,0.08); }

  /* ── Controls ── */
  #ctrl {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 14px;
    background: rgba(26,26,26,0.9);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 100px;
    padding: 7px 18px;
    backdrop-filter: blur(12px);
    z-index: 999;
    font-size: 11px;
    color: var(--text-muted);
  }
  #ctrl label { display: flex; align-items: center; gap: 7px; }
  #zoom-sl {
    -webkit-appearance: none;
    width: 100px; height: 2px;
    background: rgba(255,255,255,0.12);
    border-radius: 2px; outline: none; cursor: pointer;
  }
  #zoom-sl::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 11px; height: 11px;
    border-radius: 50%;
    background: rgba(255,255,255,0.55);
    cursor: pointer;
    transition: background 0.1s, transform 0.1s;
  }
  #zoom-sl::-webkit-slider-thumb:hover {
    background: #fff;
    transform: scale(1.2);
  }
  #zoom-val { font-family: var(--mono); font-size: 10px; color: var(--text-dim); min-width: 32px; }
  .csep { width: 1px; height: 12px; background: rgba(255,255,255,0.1); }
  kbd {
    font-family: var(--mono);
    font-size: 9.5px;
    padding: 1px 5px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 3px;
  }

  /* ── Rationale panel ── */
  #panel {
    position: fixed;
    top: 38px; right: 0;
    width: 320px;
    height: calc(100vh - 38px);
    background: rgba(24,24,24,0.97);
    border-left: 1px solid rgba(255,255,255,0.07);
    padding: 22px 20px;
    overflow-y: auto;
    z-index: 900;
    transform: translateX(100%);
    transition: transform 0.22s cubic-bezier(0.25,0,0,1);
    scrollbar-width: thin;
    scrollbar-color: rgba(255,255,255,0.07) transparent;
  }
  #panel.open { transform: translateX(0); }

  .ph { font-size: 12.5px; font-weight: 500; color: var(--text); margin-bottom: 20px; letter-spacing: -0.02em; }

  .ps {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .ps:last-child { border-bottom: none; }

  .pn {
    display: inline-flex; align-items: center; justify-content: center;
    width: 17px; height: 17px;
    background: rgba(74,158,255,0.15);
    color: #4a9eff;
    font-size: 9px; font-weight: 600;
    border-radius: 50%;
    font-family: var(--mono);
    flex-shrink: 0;
  }

  .pt {
    font-size: 11.5px; font-weight: 500;
    color: var(--text-dim);
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px;
  }

  .pb {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.68;
    padding-left: 25px;
  }
  .pb b { color: var(--text-dim); font-weight: 400; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 2px; }
</style>
</head>
<body>

<div id="hdr">
  <div id="hdr-label">voicetree · <b>node-card-redesign-v2.mockup</b></div>
  <div id="hdr-btns">
    <span id="zoom-hdr" style="font-family:var(--mono);font-size:10px;color:var(--text-muted);min-width:32px;"></span>
    <button class="hbtn" id="btn-panel">Rationale</button>
    <button class="hbtn" id="btn-reset">Reset view</button>
  </div>
</div>

<div id="wrap">
  <div id="canvas">

    <svg id="svg">
      <defs>
        <marker id="arr" markerWidth="5" markerHeight="5" refX="5" refY="2.5" orient="auto">
          <path d="M0,0.5 L0,4.5 L4.5,2.5 Z" fill="rgba(255,255,255,0.12)"/>
        </marker>
        <marker id="arr-lit" markerWidth="5" markerHeight="5" refX="5" refY="2.5" orient="auto">
          <path d="M0,0.5 L0,4.5 L4.5,2.5 Z" fill="rgba(255,255,255,0.35)"/>
        </marker>
      </defs>
    </svg>

    <!-- Card A: Root context node (starts active) -->
    <div class="card" id="ca" data-id="a" style="left:100px;top:180px;">
      <div class="c-min">
        <div class="c-title">Architecture Overview</div>
        <div class="c-body">Cytoscape.js renders circular nodes with text labels below. Size scales with graph degree.</div>
        <div class="tls">
          <div class="tl x"></div><div class="tl m"></div><div class="tl f"></div>
        </div>
      </div>
      <div class="c-full">
        <div class="c-bar">
          <div class="tls-bar">
            <div class="tl x"></div><div class="tl m"></div><div class="tl f"></div>
          </div>
          <div class="c-bar-title">Architecture Overview</div>
        </div>
        <div class="c-editor">
          <div class="ln"><span class="lnum">1</span><span class="lc h1"># Architecture Overview</span></div>
          <div class="ln"><span class="lnum">2</span><span class="lc"></span></div>
          <div class="ln"><span class="lnum">3</span><span class="lc">Cytoscape.js renders all nodes as</span></div>
          <div class="ln"><span class="lnum">4</span><span class="lc">circles with text labels below.</span></div>
          <div class="ln"><span class="lnum">5</span><span class="lc"></span></div>
          <div class="ln"><span class="lnum">6</span><span class="lc h2">## Node Sizing</span></div>
          <div class="ln"><span class="lnum">7</span><span class="lc">size = <span class="num">5 + 15 × log(degree + 3)</span></span></div>
          <div class="ln"><span class="lnum">8</span><span class="lc cm">// logarithmic with degree</span></div>
          <div class="ln"><span class="lnum">9</span><span class="lc"></span></div>
          <div class="ln"><span class="lnum">10</span><span class="lc h2">## States</span></div>
          <div class="ln"><span class="lnum">11</span><span class="lc">hover · pinned · selected</span></div>
          <div class="ln"><span class="lnum">12</span><span class="lc">dangling · context · terminal</span></div>
        </div>
      </div>
      <div class="rsz"><svg width="9" height="9" fill="none"><path d="M2 8L8 2M5 8L8 5" stroke="rgba(255,255,255,0.6)" stroke-width="1.2" stroke-linecap="round"/></svg></div>
    </div>

    <!-- Card B -->
    <div class="card" id="cb" data-id="b" style="left:500px;top:90px;">
      <div class="c-min">
        <div class="c-title">HoverEditor.ts</div>
        <div class="c-body">Triggered on cy mouseover. Positioned 18px below node. Closes via isMouseInHoverZone().</div>
        <div class="tls">
          <div class="tl x"></div><div class="tl m"></div><div class="tl f"></div>
        </div>
      </div>
      <div class="c-full">
        <div class="c-bar">
          <div class="tls-bar"><div class="tl x"></div><div class="tl m"></div><div class="tl f"></div></div>
          <div class="c-bar-title">HoverEditor.ts</div>
        </div>
        <div class="c-editor">
          <div class="ln"><span class="lnum">1</span><span class="lc h1"># HoverEditor</span></div>
          <div class="ln"><span class="lnum">2</span><span class="lc"></span></div>
          <div class="ln"><span class="lnum">3</span><span class="lc">Triggered by <span class="str">cy.on('mouseover')</span></span></div>
          <div class="ln"><span class="lnum">4</span><span class="lc">via <span class="kw">setupCommandHover(cy)</span></span></div>
          <div class="ln"><span class="lnum">5</span><span class="lc cm">// 18px below node</span></div>
          <div class="ln"><span class="lnum">6</span><span class="lc">anchoredToNodeId = <span class="kw">O.none</span></span></div>
        </div>
      </div>
      <div class="rsz"><svg width="9" height="9" fill="none"><path d="M2 8L8 2M5 8L8 5" stroke="rgba(255,255,255,0.6)" stroke-width="1.2" stroke-linecap="round"/></svg></div>
    </div>

    <!-- Card C -->
    <div class="card" id="cc" data-id="c" style="left:500px;top:340px;">
      <div class="c-min">
        <div class="c-title">EditorStore.ts</div>
        <div class="c-body">editors: Map&lt;EditorId, EditorData&gt;&#10;pinnedEditors: Set&lt;string&gt;&#10;FIFO auto-pin queue, fp-ts</div>
        <div class="tls">
          <div class="tl x"></div><div class="tl m"></div><div class="tl f"></div>
        </div>
      </div>
      <div class="c-full">
        <div class="c-bar">
          <div class="tls-bar"><div class="tl x"></div><div class="tl m"></div><div class="tl f"></div></div>
          <div class="c-bar-title">EditorStore.ts</div>
        </div>
        <div class="c-editor">
          <div class="ln"><span class="lnum">1</span><span class="lc h1"># EditorStore</span></div>
          <div class="ln"><span class="lnum">2</span><span class="lc"></span></div>
          <div class="ln"><span class="lnum">3</span><span class="lc"><span class="kw">editors:</span> Map&lt;EditorId, EditorData&gt;</span></div>
          <div class="ln"><span class="lnum">4</span><span class="lc"><span class="kw">pinnedEditors:</span> Set&lt;string&gt;</span></div>
          <div class="ln"><span class="lnum">5</span><span class="lc cm">// fp-ts Option pattern</span></div>
          <div class="ln"><span class="lnum">6</span><span class="lc">FIFO auto-pin queue</span></div>
        </div>
      </div>
      <div class="rsz"><svg width="9" height="9" fill="none"><path d="M2 8L8 2M5 8L8 5" stroke="rgba(255,255,255,0.6)" stroke-width="1.2" stroke-linecap="round"/></svg></div>
    </div>

    <!-- Card D: title only (smallest card) -->
    <div class="card" id="cd" data-id="d" style="left:280px;top:470px;">
      <div class="c-min">
        <div class="c-title">floating-windows.css</div>
        <div class="c-body">Window containers, overlay, traffic lights, macOS-style buttons.</div>
        <div class="tls">
          <div class="tl x"></div><div class="tl m"></div><div class="tl f"></div>
        </div>
      </div>
      <div class="c-full">
        <div class="c-bar">
          <div class="tls-bar"><div class="tl x"></div><div class="tl m"></div><div class="tl f"></div></div>
          <div class="c-bar-title">floating-windows.css</div>
        </div>
        <div class="c-editor">
          <div class="ln"><span class="lnum">1</span><span class="lc"><span class="kw">--card:</span> oklch(0.22 0 0);</span></div>
          <div class="ln"><span class="lnum">2</span><span class="lc"><span class="kw">--border:</span> oklch(1 0 0 / 15%);</span></div>
          <div class="ln"><span class="lnum">3</span><span class="lc cm">/* macOS traffic lights */</span></div>
          <div class="ln"><span class="lnum">4</span><span class="lc">border-radius: <span class="num">8px</span>;</span></div>
        </div>
      </div>
      <div class="rsz"><svg width="9" height="9" fill="none"><path d="M2 8L8 2M5 8L8 5" stroke="rgba(255,255,255,0.6)" stroke-width="1.2" stroke-linecap="round"/></svg></div>
    </div>

    <!-- Card E -->
    <div class="card" id="ce" data-id="e" style="left:800px;top:220px;">
      <div class="c-min">
        <div class="c-title">AnchoredEditor.ts</div>
        <div class="c-body">anchoredToNodeId = O.some(id). Persistent, tied to shadow node. Stays in place — no edge.</div>
        <div class="tls">
          <div class="tl x"></div><div class="tl m"></div><div class="tl f"></div>
        </div>
      </div>
      <div class="c-full">
        <div class="c-bar">
          <div class="tls-bar"><div class="tl x"></div><div class="tl m"></div><div class="tl f"></div></div>
          <div class="c-bar-title">AnchoredEditor.ts</div>
        </div>
        <div class="c-editor">
          <div class="ln"><span class="lnum">1</span><span class="lc h1"># AnchoredEditor</span></div>
          <div class="ln"><span class="lnum">2</span><span class="lc"></span></div>
          <div class="ln"><span class="lnum">3</span><span class="lc">anchoredToNodeId = <span class="kw">O.some</span>(nodeId)</span></div>
          <div class="ln"><span class="lnum">4</span><span class="lc cm">// persistent, stays in place</span></div>
          <div class="ln"><span class="lnum">5</span><span class="lc">Shadow node tracks cy position.</span></div>
          <div class="ln"><span class="lnum">6</span><span class="lc">No edge. Card IS the node.</span></div>
        </div>
      </div>
      <div class="rsz"><svg width="9" height="9" fill="none"><path d="M2 8L8 2M5 8L8 5" stroke="rgba(255,255,255,0.6)" stroke-width="1.2" stroke-linecap="round"/></svg></div>
    </div>

    <!-- Card F: title-only, smallest possible -->
    <div class="card" id="cf" data-id="f" style="left:310px;top:240px;">
      <div class="c-min">
        <div class="c-title">New Design Proposal</div>
        <div class="c-body">Replace circles with editor cards. Minimal by default, expand on click.</div>
        <div class="tls">
          <div class="tl x"></div><div class="tl m"></div><div class="tl f"></div>
        </div>
      </div>
      <div class="c-full">
        <div class="c-bar">
          <div class="tls-bar"><div class="tl x"></div><div class="tl m"></div><div class="tl f"></div></div>
          <div class="c-bar-title">New Design Proposal</div>
        </div>
        <div class="c-editor">
          <div class="ln"><span class="lnum">1</span><span class="lc h1"># New Design</span></div>
          <div class="ln"><span class="lnum">2</span><span class="lc"></span></div>
          <div class="ln"><span class="lnum">3</span><span class="lc str">Replace circles → cards</span></div>
          <div class="ln"><span class="lnum">4</span><span class="lc">Minimal · Hover · Active</span></div>
          <div class="ln"><span class="lnum">5</span><span class="lc cm">// anchor = stays, no edge</span></div>
        </div>
      </div>
      <div class="rsz"><svg width="9" height="9" fill="none"><path d="M2 8L8 2M5 8L8 5" stroke="rgba(255,255,255,0.6)" stroke-width="1.2" stroke-linecap="round"/></svg></div>
    </div>

  </div>
</div>

<!-- Controls -->
<div id="ctrl">
  <label>
    <input type="range" id="zoom-sl" min="30" max="150" value="100" step="5">
    <span id="zoom-val">100%</span>
  </label>
  <div class="csep"></div>
  <span><kbd>drag</kbd> to pan</span>
  <span><kbd>click</kbd> to expand</span>
  <span><kbd>esc</kbd> collapse</span>
</div>

<!-- Rationale panel -->
<div id="panel">
  <div class="ph">Design Rationale</div>

  <div class="ps">
    <div class="pt"><span class="pn">1</span>Cards are always visible</div>
    <div class="pb">Every node shows its content — title + body preview — with <b>no interaction required</b>. The graph is readable as a spatial document, not just a topology diagram. Inspired by Obsidian Canvas.</div>
  </div>

  <div class="ps">
    <div class="pt"><span class="pn">2</span>Near-invisible chrome</div>
    <div class="pb">Borders at <b>6% white opacity</b> in default state — you see content, not containers. Buttons only appear on hover. The card recedes; the text leads.</div>
  </div>

  <div class="ps">
    <div class="pt"><span class="pn">3</span>Blue border on active</div>
    <div class="pb">One card is active at a time. The <b>blue border</b> signals "this is the editor" clearly without disrupting other cards. Familiar from Obsidian, Figma, VS Code.</div>
  </div>

  <div class="ps">
    <div class="pt"><span class="pn">4</span>Edges to border midpoints</div>
    <div class="pb">Bezier curves connect to the <b>nearest border edge</b> of each card — natural for rectangles, topology reads directionally.</div>
  </div>

  <div class="ps">
    <div class="pt"><span class="pn">5</span>Anchor = card stays, no edge</div>
    <div class="pb">Anchoring no longer spawns a new graph edge to a floating editor. The card <b>is</b> the node. Anchored = persistent open state at that position.</div>
  </div>

  <div class="ps">
    <div class="pt"><span class="pn">6</span>Performance at scale</div>
    <div class="pb">Minimal cards are <b>pure HTML + CSS</b> — no CodeMirror instance. Only the active card has the full editor. 200 nodes = 1 heavy + 199 lightweight.</div>
  </div>
</div>

<script>
const S = { zoom: 1, px: 80, py: 50, pan: false, psx: 0, psy: 0 };

const EDGES = [
  { f:'a', t:'f' }, { f:'f', t:'b' }, { f:'f', t:'c' },
  { f:'b', t:'e' }, { f:'c', t:'d' }, { f:'a', t:'d' },
  { f:'e', t:'c' },
];

const wrap    = document.getElementById('wrap');
const canvas  = document.getElementById('canvas');
const svg     = document.getElementById('svg');
const zoomSl  = document.getElementById('zoom-sl');
const zoomVal = document.getElementById('zoom-val');
const zoomHdr = document.getElementById('zoom-hdr');

// ── Geometry ──────────────────────────────────────────────────
function rect(el) {
  const x = parseInt(el.style.left), y = parseInt(el.style.top);
  const act = el.classList.contains('active');
  const w = el.offsetWidth  || (act ? 380 : 240);
  const h = el.offsetHeight || (act ? 280 :  80);
  return { x, y, w, h, cx: x+w/2, cy: y+h/2 };
}

function sides(a, b) {
  const dx = b.cx-a.cx, dy = b.cy-a.cy;
  return Math.abs(dx) > Math.abs(dy)
    ? { fs: dx>0?'r':'l', ts: dx>0?'l':'r' }
    : { fs: dy>0?'b':'t', ts: dy>0?'t':'b' };
}

function bp(r, s) {
  return s==='r' ? {x:r.x+r.w, y:r.cy}
       : s==='l' ? {x:r.x,     y:r.cy}
       : s==='b' ? {x:r.cx,    y:r.y+r.h}
                 : {x:r.cx,    y:r.y};
}

// ── Draw edges ────────────────────────────────────────────────
function draw() {
  svg.querySelectorAll('.edge').forEach(e => e.remove());
  EDGES.forEach(({ f, t }) => {
    const fe = document.querySelector(`[data-id="${f}"]`);
    const te = document.querySelector(`[data-id="${t}"]`);
    if (!fe || !te) return;
    const fr = rect(fe), tr = rect(te);
    const { fs, ts } = sides(fr, tr);
    const s = bp(fr, fs), e = bp(tr, ts);
    const off = Math.min(Math.hypot(e.x-s.x, e.y-s.y)*0.35, 80) + 20;
    const c = (side, pt) => {
      const o = {...pt};
      if (side==='r') o.x+=off; if (side==='l') o.x-=off;
      if (side==='b') o.y+=off; if (side==='t') o.y-=off;
      return o;
    };
    const c1 = c(fs, s), c2 = c(ts, e);
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d', `M${s.x},${s.y} C${c1.x},${c1.y} ${c2.x},${c2.y} ${e.x},${e.y}`);
    path.classList.add('edge');
    path.dataset.f = f; path.dataset.t = t;
    svg.appendChild(path);
  });
}

function hilite(id, on) {
  svg.querySelectorAll('.edge').forEach(p => {
    if (p.dataset.f===id || p.dataset.t===id) p.classList.toggle('lit', on);
  });
}

// ── Transform ─────────────────────────────────────────────────
function apply() {
  canvas.style.transform = `translate(${S.px}px,${S.py}px) scale(${S.zoom})`;
  const pct = Math.round(S.zoom*100)+'%';
  zoomVal.textContent = pct;
  zoomHdr.textContent = pct;
  zoomSl.value = Math.round(S.zoom*100);
  draw();
}

// ── Cards ──────────────────────────────────────────────────────
document.querySelectorAll('.card').forEach(card => {
  const id = card.dataset.id;

  card.addEventListener('mouseenter', () => { hilite(id, true); });
  card.addEventListener('mouseleave', () => { hilite(id, false); });

  card.addEventListener('click', e => {
    if (e.target.classList.contains('tl')) {
      if (e.target.classList.contains('x')) deactivate(card);
      e.stopPropagation(); return;
    }
    if (e.target.closest('.rsz')) return;

    const was = card.classList.contains('active');
    document.querySelectorAll('.card.active').forEach(deactivate);
    if (!was) { card.classList.add('active'); card.style.zIndex=100; }
    setTimeout(draw, 200);
    e.stopPropagation();
  });

  // drag via titlebar
  const bar = card.querySelector('.c-bar');
  if (bar) {
    let d=false, sx,sy,ox,oy;
    bar.addEventListener('mousedown', e => {
      if (e.target.classList.contains('tl')) return;
      d=true; sx=e.clientX; sy=e.clientY;
      ox=parseInt(card.style.left); oy=parseInt(card.style.top);
      card.style.zIndex=200; e.stopPropagation();
    });
    document.addEventListener('mousemove', e => {
      if (!d) return;
      card.style.left=(ox+(e.clientX-sx)/S.zoom)+'px';
      card.style.top =(oy+(e.clientY-sy)/S.zoom)+'px';
      draw();
    });
    document.addEventListener('mouseup', () => {
      if (d) { d=false; card.style.zIndex=card.classList.contains('active')?100:''; }
    });
  }

  // resize
  const rsz = card.querySelector('.rsz');
  if (rsz) {
    let r=false,sx,sy,ow,oh;
    rsz.addEventListener('mousedown', e => {
      r=true; sx=e.clientX; sy=e.clientY;
      ow=card.offsetWidth; oh=card.offsetHeight;
      e.stopPropagation(); e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
      if (!r) return;
      card.style.width =Math.max(240, ow+(e.clientX-sx)/S.zoom)+'px';
      card.style.height=Math.max(180, oh+(e.clientY-sy)/S.zoom)+'px';
      draw();
    });
    document.addEventListener('mouseup', () => { r=false; });
  }
});

function deactivate(card) {
  card.classList.remove('active','focused');
  card.style.width=''; card.style.height=''; card.style.zIndex='';
  setTimeout(draw, 200);
}

// ── Pan ───────────────────────────────────────────────────────
wrap.addEventListener('mousedown', e => {
  const onBg = e.target===wrap||e.target===canvas||e.target===svg||e.target.tagName==='path';
  if (!onBg) return;
  S.pan=true; S.psx=e.clientX-S.px; S.psy=e.clientY-S.py;
  wrap.classList.add('panning');
});
document.addEventListener('mousemove', e => {
  if (!S.pan) return;
  S.px=e.clientX-S.psx; S.py=e.clientY-S.psy; apply();
});
document.addEventListener('mouseup', () => { S.pan=false; wrap.classList.remove('panning'); });

wrap.addEventListener('click', e => {
  if (e.target===wrap||e.target===canvas)
    document.querySelectorAll('.card.active').forEach(deactivate);
});

// ── Zoom ──────────────────────────────────────────────────────
zoomSl.addEventListener('input', () => { S.zoom=parseInt(zoomSl.value)/100; apply(); });
wrap.addEventListener('wheel', e => {
  e.preventDefault();
  S.zoom = Math.max(0.3, Math.min(1.5, S.zoom+(e.deltaY>0?-0.06:0.06)));
  apply();
}, { passive:false });

document.addEventListener('keydown', e => {
  if (e.key==='Escape') document.querySelectorAll('.card.active').forEach(deactivate);
});

// ── Panel / reset ─────────────────────────────────────────────
document.getElementById('btn-panel').addEventListener('click', function() {
  document.getElementById('panel').classList.toggle('open');
  this.classList.toggle('on');
});
document.getElementById('btn-reset').addEventListener('click', () => {
  S.zoom=1; S.px=80; S.py=50; apply();
});

// ── Init ──────────────────────────────────────────────────────
window.addEventListener('load', () => {
  document.getElementById('ca').classList.add('active');
  document.getElementById('ca').style.zIndex=100;
  apply();
  setTimeout(draw, 80);
});
apply();
</script>
</body>
</html>
